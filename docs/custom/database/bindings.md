---
title: 'Custom: Биндинги'
---

# Custom: Биндинги

Биндинги позволяют использовать MQTT-топики, публикуемые стаоронними устройствами или сервисами, в качестве источников данных для устройств HOMEd Custom.

Биндинги описываются как JSON-обект, ключами которого являются имена описываемых свойств. Структура описания биндингов в базе данных выглядит так:

```json
{
  ...
  "real": true,
  "exposes": ["switch", "temperature"],
  "bindings":
  {
    "status":
    {
       "inTopic": "switch/status/topic",
       "inPattern": "{{ on if json.switch == true else off }}",
       "outTopic": "switch/command/topic",
       "outPattern": "{\"switch\":{{ true if value == on else false }}}"
    },
    "temperature":
    {
       "inTopic": "temperature/status/topic",
       "inPattern": "{{ json.temperature }}"
    }
  }
  ...
}
```

!!! warning ""

    Биндинги работают только в случае, когда в настройках устройства включен параметр `real`.

## Параметры биндингов

### `inTopic`

MQTT-топик, в который устройство публикует состояние описываемого свойства. Является обязательным в случае, если отсутствует параметр `outTopic`.

### `inPattern`

Шаблон для получения состояния описываемого свойства из топика `inTopic`. В случае отсутствия этого параметра, данные будут использованы без изменений.

Подробнее в разделе [шаблоны](#_2).

### `outTopic`

MQTT-топик, который необходимо опубликовать для изменения состояния описываемого свойства. Является обязательным в случае, если отсутствует параметр `inTopic`.

### `outPattern`

Шаблон для передечи состояния описываемого свойства в топик `outTopic`. В случае отсутствия этого параметра данные будут опубликованы без изменений.

Подробнее в разделе [шаблоны](#_2).

## Шаблоны

Шаблон это простая строка, которая может содержать части текста, обернутые двойными фигурными скобками `{{ ... }}`. Эти части теста будут автоматически заменяться на значение, зависящее от составляющих элементов шаблона.

!!! warning ""

    Парсер шаблонов находит элементы, разделяя исходную строку по пробелам, поэтому, при составлении шаблонов, необходимо обосабливать каждый элемент пробелами, если он не находится в начале или в конце строки.

### `json`

Этот элемент шаблона применим к случаям, когда стороннее устройство публикует свое состояние в виде JSON-объекта, и позволяет получать из этого объекта необходимые параметры. Примеры использования элемента приведены ниже.

Получение параметра `pressure`:
```
{{ json.pressure }}
```

Получение параметра из объекта, вложенного в массив:
```
{{ json.values[2].status }}
```

Получение параметра c ключом, содержащим пробелы:
```
{{ 'json.some key with spaces' }}
```

### `value`

Этот элемент шаблона применим к случаям, когда стороннее устройство публикует свое состояние "как есть" или когда необходимо передать на стороннее устройство значение свойства, вложив его некую текстовую конструкцию, например, в JSON-объект. Пример использования элемента:

```
{\"setStatus\":\"{{ value }}\"}
```

### `format`

Этот элемент шаблона позволяет преобразовывать данные из одного формата в другой. На данный момент поддерживаются следующие функции:

| Фцнкция | Описание |
|---------|----------|
| `fromHex` | преобразование HEX-строки в список чисел (актуально для работы с цветом) |
| `toHex`   | преобразование списка чисел в HEX-строку (актуально для работы с цветом) |
| `time`    | преобразование меток времени Unix Time в строку |

Примеры использования элемента:

```
{{ format.fromHex(12FE0A) }} # 18,254,10
```

```
{{ format.toHex(10,20,30) }} # 0A141E
```

```
{{ format.time() }} # текущая метка времени Unix Time, например
```

```
{{ format.time(hh:mm:ss) }} # текущее время (с учетом часового пояса)
```

В случае, если описание элемента содержит пробелы, оно _должно_ быть обернуто в одинарные кавычки, например:
```

{{ 'format.time(dd:MM:yyyy, hh:mm|458802300)' }} # 16.07.1984, 09:05

```

### `url`

Этот элемент шаблона позволяет получать данные из url-encoded строк. Пример получения температуры из строки `status=on&temperature=20.5&humidity=56`:

```
{{ url.temperature }}
```

В случае, если строка содержит кириллицу или спецсимволы, например, пробелы - `%20`, они будут автоматически декодированы.

### `if/else`

Этот элемент шаблона является условным, его итоговое значение зависит от результатов сравнения других элементов.

Поддерживаются следующие условные операторы:

| Оператор | Описание |
|----------|----------|
| `is defined`   | левая часть выражения не является пустой
| `is undefined` | левая часть выражения является пустой
| `==`           | левая часть выражения равна правой части
| `!=`           | левая часть выражения не равна правой части
| `>`            | левая часть выражения больше правой части
| `>=`           | левая часть выражения больше или равна правой части
| `<`            | левая часть выражения меньше правой части
| `<=`           | левая часть выражения меньше или равна правой части

!!! warning ""

    Условные операторы `>`, `>=`, `<` и `<=` применимы только к числовым значениям, в противном случае результат сравнения может оказаться непредсказуемым.

Примеры использования:

```
{{ json.value if json.value is defined else NULL }}
```

```
{{ on if json.status == true else off }}
```

```
{{ false if value <= 20 else true }}
```

В случае, если сравниваемые или итоговые значения содержат пробелы, они _должны_ быть обернуты в одинарные кавычки:

```
{{ 'some value' if json.value == 'few words string' else 'other result' }}
```

Данный элемент так же может быть использован рекурсивно, что позволяет проверить несколько условий сразу:
```
{{ 1 if value == 2 else 3 if value != 4 else 5 }}
```

## Математические выражения

Помимо описанных выше элементов, в шаблонах так же могут быть использованы математические выражения. В этом случае соответсвующая часть текста будет заменена числовым результатом вычислений. Например:

```
{{ value * 4.815162342 }}
```

```
{{ ( value + 2 ) / 10 }}
```

```
{{ round( json.voltage ) }}
```

Список досутпных функций можно посмотреть [здесь](https://github.com/u236/homed-service-common/blob/master/parser.cpp#L96-L103).

## Комбинирование элеметнов

В случаях, когда необходимо совместное использование нескольких элементов в одном шаблоне, каждый элемент _должен_ быть обернут в _собственные_ двойные фигурные скобки. Это правило касается, в первую очередь, использования математических выражений и других элементов внутри шаблонов `format` и `if/else`.

Примеры:

```
{{ format.time(hh:mm|{{ value }}) }}
```

```
{{ true if {{ value * 10 }} < 50 else false }}
```

```
{{ json.number * {{ 10 if json.number > 20 else 100 }} }}
```

## Экранирование

В случае, когда нужно использовать элементы шаблона в качестве простого текста, их _необходимо_ экранировать двумя обратными слэшами, например:

```
{{ json.value if json.value is defined else '\\json.value is undefined' }}
```
